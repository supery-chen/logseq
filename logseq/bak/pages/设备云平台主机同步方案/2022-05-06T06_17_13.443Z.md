public:: false

- #工作 #控客 #私有

- > 根据主机表现,实时更新画像
  根据主机画像,对主机进行打分
  根据主机打分,按优先级同步主机
	-
	
- ## 数据源

- > 数据主要来自kafka,处理后转换为打分平台对应事件,具体信息如下表

- |topic|来源|事件|
  |--|--|--|
  |inner-ccuRelation|iot-mqtt-auth|CCU_RELATION_CHANGED|
  |cloudReqRespInfo|API、SVC|CCU_OPT_EXECUTE[:br]CCU_OPT_RESP[:br]CCU_OPT_SUCCESS[:br]CCU_OPT_FAILED[:br]CCU_OPT_TIMEOUT|
  |inner-ccuOnline|SVC|CCU_ONLINE|
  |inner-ccuOffline|SVC|CCU_OFFLINE|
  |iot-ccuActive_NoWorkingOnline|SVC|CCU_ACTIVE_NOT_WORKING|
  |iot-ccuLinkHealthCheck_Success|SVC|CCU_HEALTH_CHECK_SUCCESS|
  |iot-ccuLinkHealthCheck_Failed|SVC|CCU_HEALTH_CHECK_FAILED|
  |iot-ccuWorkingOnline|SVC|CCU_SYNC_SUCCESS|
  |iot-ccuSync_SYNC_INFO_ERROR|SVC|CCU_SYNC_FAILED|
  -
  
- ## 画像

- > 根据事件更新画像信息,事件对应画像信息如下表

- | 字段     | 子字段                             | 类型          | 对应事件                                                     | 事件对应操作 |
  | -------- | ---------------------------------- | ------------- | ------------------------------------------------------------ | ------------ |
  | basic    |                                    | object        |                                                              |              |
  |          | link                               | int           | CCU_ONLINE<br />CCU_ONLINE<br />CCU_SYNC_SUCCESS<br />CCU_SYNC_FAILED<br />CCU_OPT_RESP<br />CCU_OPT_SUCCESS<br />CCU_PUSH |              |
  |          | link_type                          | string        |                                                              |              |
  | stable   |                                    |               |                                                              |              |
  |          | online_frequency                   | int           |                                                              |              |
  |          | offline_frequency                  | int           |                                                              |              |
  |          | last_online_time                   | long          |                                                              |              |
  |          | last_offline_time                  | long          |                                                              |              |
  |          | last_10_onoff_records              | list\<string> |                                                              |              |
  |          |                                    |               |                                                              |              |
  |          | sync_frequency                     | int           |                                                              |              |
  |          | sync_success_frequency             | int           |                                                              |              |
  |          | last_sync_complete_time            | long          |                                                              |              |
  |          | last_sync_complete_result          | string        |                                                              |              |
  |          | last_20_sync_result_records        | list\<string> |                                                              |              |
  |          |                                    |               |                                                              |              |
  |          | opt_frequency                      | int           |                                                              |              |
  |          | opt_success_frequency              | int           |                                                              |              |
  |          | last_opt_complete_time             | long          |                                                              |              |
  |          | last_opt_complete_result           | string        |                                                              |              |
  |          | last_50_opt_result_records         | list\<string> |                                                              |              |
  |          |                                    |               |                                                              |              |
  |          | no_link_frequency                  | int           |                                                              |              |
  |          | last_100_no_link_times             | list\<long>   |                                                              |              |
  |          | active_no_working_online           | int           |                                                              |              |
  |          | last_active_no_working_online_time | long          |                                                              |              |
  |          | health_check_success_frequency     | int           |                                                              |              |
  |          | last_health_check_success_time     | long          |                                                              |              |
  |          | health_check_failed_frequency      | int           |                                                              |              |
  |          | last_health_check_failed_time      | long          |                                                              |              |
  | active   |                                    |               |                                                              |              |
  |          | opt_frequency                      | int           |                                                              |              |
  |          | last_opt_time                      | long          |                                                              |              |
  |          | last_100_opt_times                 | list\<long>   |                                                              |              |
  |          | push_frequency                     | int           |                                                              |              |
  |          | last_push_time                     | long          |                                                              |              |
  |          | last_100_push_times                | list\<long>   |                                                              |              |
  | relation |                                    |               |                                                              |              |
  |          | user_count                         | int           |                                                              |              |
  |          | users                              | list\<string> |                                                              |              |
  |          | device_count                       | int           |                                                              |              |
  |          | devices                            | list\<string> |                                                              |              |

  

- 

- |事件|画像|
  |----|----|
  |CCU_RELATION_CHANGED|如果关联信息为空<br /><br />如果guan'lian|
  |CCU_OPT_EXECUTE|stable.opt_frequency+1<br />active.last_opt_time=eventTime<br />active.opt_frequency+1<br />active.last_100_opt_times.add(eventTime)|
  |CCU_OPT_RESP|basic.link=1|
  |CCU_OPT_SUCCESS|basic.link=1<br />stable.opt_success_frequency+1<br />stable.last_opt_complete_time=eventTime<br />stable.last_opt_complete_result=eventType<br />stable.last_50_opt_result_records.add(eventTime + "@" + eventType)|
  |CCU_OPT_FAILED / CCU_OPT_TIMEOUT|stable.last_opt_complete_time=eventTime<br />stable.last_opt_complete_result=eventType<br />stable.last_50_opt_result_records.add(eventTime + "@" + eventType)<br />**下面两个仅在响应失败原因包含no link to时才变化**<br />stable.no_link_frequency+1<br />stable.last_100_no_link_times.add(eventTime)|
  |CCU_PUSH|basic.link=1<br />active.last_push_time=eventTime<br />active.push_frequency+1<br />active.last_100_push_times.add(eventTime)|
  |CCU_ONLINE|basic.link=1<br />basic.link_type<br />stable.online_frequency+1<br />stable.last_online_time=eventTime<br />stable.last_10_onoff_records.add(eventTime + "@" + eventType + "@" + linkType)|
  |CCU_OFFLINE|basic.link=0<br />stable.offline_frequency+1<br />stable.last_offline_time=eventTime<br />stable.last_10_onoff_records.add(eventTime + "@" + eventType + "@" + linkType)|
  |CCU_ACTIVE_NOT_WORKING|stable.active_no_working_online+1<br />stable.last_active_no_working_online_time=eventTime<br />stable.health_check_success_frequency=null<br />stable.health_check_failed_frequency=null<br />stable.last_health_check_success_time=null<br />stable.last_health_check_failed_time=null|
  |CCU_HEALTH_CHECK_SUCCESS|stable.health_check_success_frequency+1<br />stable.last_health_check_success_time=eventTime|
  |CCU_HEALTH_CHECK_FAILED|stable.health_check_failed_frequency+1<br />stable.last_health_check_failed_time=eventTime|
  |CCU_SYNC_SUCCESS|basic.link=1<br />stable.sync_frequency+1<br />stable.sync_success_frequency+1<br />stable.last_sync_complete_time=eventTime<br />stable.last_sync_complete_result=eventType<br />stable.last_20_sync_result_records.add(eventTime + "@" + eventType)<br /><br />stable.active_no_working_online=0<br />stable.last_active_no_working_online_time=null<br />stable.health_check_success_frequency=null<br />stable.health_check_failed_frequency=null<br />stable.last_health_check_success_time=null<br />stable.last_health_check_failed_time=null<br />stable.no_link_frequency=0<br />stable.last_100_no_link_times=[]|
  |CCU_SYNC_FAILED|stable.sync_frequency+1<br />stable.last_sync_complete_time=eventTime<br />stable.last_sync_complete_result=eventType<br />stable.last_20_sync_result_records.add(eventTime + "@" + eventType)|
- ## 打分
  -
  -
- ## 同步
  -
  -